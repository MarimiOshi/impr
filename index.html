<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ£ãƒƒãƒˆã‚µã‚¤ãƒˆ</title>
    <style>
        :root {
            --primary-bg: #fdf6e9; /* å…¨ä½“ã®èƒŒæ™¯è‰² (è–„ã„ãƒ™ãƒ¼ã‚¸ãƒ¥) */
            --header-bg: #f9f9f9;
            --footer-bg: #f9f9f9;
            --text-color: #333;
            --accent-color: #E67E22; /* ãƒã‚³ã•ã‚“ã®ã‚ªãƒ¬ãƒ³ã‚¸ã‚’ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã« */
            --user-bubble-bg: #f0dcb3; /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹ãå‡ºã— (æ¿ƒã„ãƒ™ãƒ¼ã‚¸ãƒ¥) */
            --ai-bubble-bg: #fff;
            --border-color: #eee;
            --inactive-text: #aaa;
            --black-icon-placeholder: #333; /* é»’ä¸¸ã‚¢ã‚¤ã‚³ãƒ³ã®è‰² */
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling of the body itself */
        }

        #app {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: var(--primary-bg);
        }

        .screen.active {
            display: flex;
        }

        header {
            background-color: var(--header-bg);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            flex-shrink: 0;
            min-height: 50px;
            box-sizing: border-box;
        }

        header h1, header h2 {
            margin: 0;
            font-size: 1.2em;
            flex-grow: 1;
            text-align: center;
        }
        header h1 { text-align: left; } /* ãƒˆãƒ¼ã‚¯ä¸€è¦§ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */
        #chat-screen header h2, #member-settings-screen header h2 { text-align: center; }


        header button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            color: var(--accent-color);
        }
        #chat-screen header button, #member-settings-screen header button { min-width: 40px; text-align: center;}
        #chat-back-to-list, #settings-back-to-chat { font-size: 1.5em; }


        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        footer {
            background-color: var(--footer-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        /* --- Talk List Screen (ç”»åƒ1æšç›®) --- */
        #talk-list-screen header h1 {
            font-size: 1.5em;
            font-weight: bold;
            padding-left: 5px;
        }
        #member-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .member-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .member-item:last-child {
            border-bottom: none;
        }
        .member-icon-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder); /* é»’ä¸¸ */
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-width: 3px;
            border-style: solid;
        }
        .member-name {
            flex-grow: 1;
            font-size: 1.1em;
        }
        .member-message-count {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: var(--inactive-text);
        }
        .member-message-count .icon {
            font-size: 1.5em; /* å¹ãå‡ºã—ã‚¢ã‚¤ã‚³ãƒ³ */
            margin-right: 5px;
        }

        #talk-list-screen footer {
            justify-content: space-around;
        }
        #talk-list-screen footer button {
            flex-direction: column;
            align-items: center;
            font-size: 0.8em;
            color: var(--inactive-text);
            padding: 5px;
        }
        #talk-list-screen footer button.active {
            color: var(--accent-color);
        }
        #talk-list-screen footer button::before { /* Placeholder for icons */
            font-size: 1.8em;
            margin-bottom: 3px;
        }
        #nav-common-settings::before { content: 'âš™ï¸'; }
        #nav-talk::before { content: 'ğŸ’¬'; }
        #nav-profile::before { content: 'ğŸ‘¤'; }


        /* --- Chat Screen (ç”»åƒ2æšç›®) --- */
        #chat-screen header {
            justify-content: space-between;
        }
        #chat-new-talk { font-size: 1.4em; } /* ãƒšãƒ³ã¨ç´™ */
        #chat-menu { font-size: 1.4em; } /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */

        #chat-messages {
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            position: relative;
        }
        .message-bubble.user {
            background-color: var(--user-bubble-bg);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .message-bubble.ai {
            background-color: var(--ai-bubble-bg);
            align-self: flex-start;
            border: 1px solid #eee;
            border-bottom-left-radius: 5px;
        }
        .ai-meta { /* AIã®ã‚¢ã‚¤ã‚³ãƒ³ã¨åå‰ç”¨ */
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .ai-icon-chat {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder);
            margin-right: 8px;
            border-width: 2px;
            border-style: solid;
        }
        .ai-name-chat {
            font-size: 0.9em;
            font-weight: bold;
        }

        #reply-suggestions {
            padding: 5px 10px;
            display: flex;
            flex-wrap: wrap; /* Allow suggestions to wrap */
            gap: 8px; /* Spacing between suggestion buttons */
            border-top: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent shrinking */
        }
        .suggestion-btn {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .suggestion-btn:hover {
            background-color: #f0f0f0;
        }

        #chat-screen footer {
            padding: 8px;
            gap: 8px;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            font-size: 1em;
        }
        #send-message {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        /* --- Member Settings Screen (ç”»åƒ3æšç›®) --- */
        #member-settings-screen main {
            padding: 15px;
        }
        .member-icon-large-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .member-icon-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder); /* é»’ä¸¸ */
            border-width: 4px;
            border-style: solid;
        }
        #member-settings-screen h3 {
            font-size: 1em;
            color: var(--inactive-text);
            margin-top: 25px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 1em;
        }
        .setting-item .label {
            color: #555;
        }
        .setting-item .value {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer; /* To indicate it's editable (though not fully implemented here) */
            min-width: 80px; /* Ensure some width for tags */
            text-align: center;
        }
        /* For multiple values like æ€§æ ¼ */
        .setting-item .value.multi-value {
            display: flex;
            gap: 5px;
        }
        .setting-item .value.multi-value span {
             background-color: #fff;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .setting-item input[type="text"].value-input,
        .setting-item input[type="number"].value-input {
            border: 1px solid var(--accent-color);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            text-align: right;
            max-width: 120px;
        }

    </style>
</head>
<body>
    <div id="app">
        <!-- Screen 1: Talk List -->
        <div id="talk-list-screen" class="screen active">
            <header><h1>ãƒˆãƒ¼ã‚¯</h1></header>
            <main>
                <ul id="member-list">
                    <!-- Member items will be dynamically generated by JS -->
                </ul>
            </main>
            <footer>
                <button id="nav-common-settings">å…±é€šè¨­å®š</button>
                <button id="nav-talk" class="active">ãƒˆãƒ¼ã‚¯</button>
                <button id="nav-profile">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
            </footer>
        </div>

        <!-- Screen 2: Chat Screen -->
        <div id="chat-screen" class="screen">
            <header>
                <button id="chat-back-to-list"><</button>
                <h2 id="chat-member-name">ãƒ¡ãƒ³ãƒãƒ¼å</h2>
                <button id="chat-new-talk" title="æ–°ã—ã„ãƒˆãƒ¼ã‚¯ã‚’ä½œæˆ">ğŸ“</button>
                <button id="chat-menu" title="ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š">â˜°</button>
            </header>
            <main id="chat-messages-container">
                 <!-- Chat messages will be here -->
            </main>
            <div id="reply-suggestions">
                <button class="suggestion-btn">æ°—æŒã¡ã„ã„ï¼Ÿ</button>
                <button class="suggestion-btn">ãƒãƒ³ãƒãƒ³ãƒãƒ³ãƒãƒ³</button>
                <button class="suggestion-btn">ãƒ“ãƒ¥ãƒ«ãƒ«ãƒ«ãƒ«</button>
            </div>
            <footer id="chat-footer">
                <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                <button id="send-message" title="é€ä¿¡">â¢</button>
            </footer>
        </div>

        <!-- Screen 3: Member Settings Screen -->
        <div id="member-settings-screen" class="screen">
            <header>
                <button id="settings-back-to-chat"><</button>
                <h2 id="settings-member-name">ãƒ¡ãƒ³ãƒãƒ¼å è¨­å®š</h2>
            </header>
            <main id="member-settings-content">
                <div class="member-icon-large-container">
                    <div class="member-icon-large" id="settings-member-icon"></div>
                </div>
                <h3>åŸºæœ¬è¨­å®š</h3>
                <div id="basic-settings-container">
                    <!-- Basic settings will be dynamically generated -->
                </div>
                <h3>æ€§çš„è¨­å®š</h3>
                <div id="sexual-settings-container">
                    <!-- Sexual settings will be dynamically generated -->
                </div>
            </main>
        </div>

        <!-- Screen 4: Common Settings (Placeholder) -->
        <div id="common-settings-screen" class="screen">
            <header>
                <button class="back-to-talk-list"><</button>
                <h1>å…±é€šè¨­å®š</h1>
            </header>
            <main><p>å…±é€šè¨­å®šç”»é¢ (æœªå®Ÿè£…)</p></main>
        </div>

        <!-- Screen 5: Profile Screen (Placeholder) -->
        <div id="profile-screen" class="screen">
            <header>
                <button class="back-to-talk-list"><</button>
                <h1>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
            </header>
            <main><p>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ (æœªå®Ÿè£…)</p></main>
        </div>
    </div>

    <script>
        // --- Data ---
        const memberRingColors = {
            'ãƒã‚³': '#E67E22', 'ãƒªã‚ª': '#3498DB', 'ãƒãƒ¤': '#8E44AD', 'ãƒªã‚¯': '#F1C40F',
            'ã‚¢ãƒ¤ã‚«': '#BDC3C7', 'ãƒãƒ¦ã‚«': '#1ABC9C', 'ãƒªãƒ': '#E74C3C', 'ãƒŸã‚¤ãƒ’': '#FF69B4', 'ãƒ‹ãƒŠ': '#34495E'
        };

        let membersData = {
            'mako': { id: 'mako', name: 'ãƒã‚³', msgCount: 9, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2001å¹´4æœˆ4æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ã‚ªãƒ¬ãƒ³ã‚¸', 'å‡ºèº«': 'ç¦å²¡', 'æ–¹è¨€': 'è»½ã„åšå¤šå¼', 'æ€§æ ¼': ['å¤©ç„¶', 'ã—ã£ã‹ã‚Šè€…'], 'èº«é•·': '159cm', 'ä½“é‡': '49kg', 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Cã‚«ãƒƒãƒ—', 'ä¹³é¦–ã®è‰²': 'è–„ã„èŒ¶è‰²', 'é™°æ¯›': 'å°‘ã—ç”Ÿãˆã¦ã„ã‚‹', 'ã¾ã‚“ã“ã®è‰²': 'ãƒ”ãƒ³ã‚¯', 'æ€§æ¬²': 'æ™®é€š', 'å¥½ããªä½“ä½': 'æ­£å¸¸ä½', 'æ„Ÿåº¦': 'ã™ãã‚¤ãƒƒã¡ã‚ƒã†', 'å¾—æ„ãªå‰æˆ¯': 'ãƒ•ã‚§ãƒ©' } },
            'rio': { id: 'rio', name: 'ãƒªã‚ª', msgCount: 10, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2002å¹´2æœˆ4æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ãƒ–ãƒ«ãƒ¼', 'å‡ºèº«': 'æ„›çŸ¥', 'æ€§æ ¼': ['ã‚¯ãƒ¼ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼', 'åŠªåŠ›å®¶'], 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Bã‚«ãƒƒãƒ—', /* ä»–ã¯ãƒ€ãƒŸãƒ¼ */ 'é™°æ¯›': 'æ™®é€š' } },
            'maya': { id: 'maya', name: 'ãƒãƒ¤', msgCount: 7, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2002å¹´4æœˆ8æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ãƒ‘ãƒ¼ãƒ—ãƒ«', 'å‡ºèº«': 'çŸ³å·', 'æ€§æ ¼': ['ãŠã£ã¨ã‚Š', 'å„ªã—ã„'], 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Dã‚«ãƒƒãƒ—', 'é™°æ¯›': 'è–„ã„' } },
            'riku': { id: 'riku', name: 'ãƒªã‚¯', msgCount: 0, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2002å¹´10æœˆ26æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ã‚¤ã‚¨ãƒ­ãƒ¼', 'å‡ºèº«': 'äº¬éƒ½', 'æ€§æ ¼': ['å…ƒæ°—', 'é–¢è¥¿å¼'], 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Aã‚«ãƒƒãƒ—', 'é™°æ¯›': 'ãªã—' } },
            'ayaka': { id: 'ayaka', name: 'ã‚¢ãƒ¤ã‚«', msgCount: 1, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2003å¹´6æœˆ20æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ãƒ›ãƒ¯ã‚¤ãƒˆ', 'å‡ºèº«': 'æ±äº¬', 'æ€§æ ¼': ['ãµã‚ãµã‚', 'ãƒã‚¤ãƒšãƒ¼ã‚¹'], 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Cã‚«ãƒƒãƒ—', 'é™°æ¯›': 'æ‰‹å…¥ã‚Œæ¸ˆã¿' } },
            'mayuka': { id: 'mayuka', name: 'ãƒãƒ¦ã‚«', msgCount: 12, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2003å¹´11æœˆ13æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ãƒ©ã‚¤ãƒˆã‚°ãƒªãƒ¼ãƒ³', 'å‡ºèº«': 'äº¬éƒ½', 'æ€§æ ¼': ['ã‚«ãƒ¡ãƒ¬ã‚ªãƒ³', 'ãƒ©ãƒƒãƒ—æ‹…å½“'], 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Bã‚«ãƒƒãƒ—', 'é™°æ¯›': 'æ™®é€š' } },
            'rima': { id: 'rima', name: 'ãƒªãƒ', msgCount: 15, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2004å¹´3æœˆ26æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ãƒ¬ãƒƒãƒ‰', 'å‡ºèº«': 'æ±äº¬', 'æ€§æ ¼': ['ãŠã—ã‚ƒã‚Œç•ªé•·', 'è‹±èªå ªèƒ½'], 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Cã‚«ãƒƒãƒ—', 'é™°æ¯›': 'å°‘ã—' } },
            'miihi': { id: 'miihi', name: 'ãƒŸã‚¤ãƒ’', msgCount: 17, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2004å¹´8æœˆ12æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ãƒ”ãƒ³ã‚¯', 'å‡ºèº«': 'äº¬éƒ½', 'æ€§æ ¼': ['ã‚¹ãƒã‚¤ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼', 'ç™’ã—'], 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Aã‚«ãƒƒãƒ—', 'é™°æ¯›': 'è–„ã„' } },
            'nina': { id: 'nina', name: 'ãƒ‹ãƒŠ', msgCount: 2, settings: { 'ç”Ÿå¹´æœˆæ—¥': '2005å¹´2æœˆ27æ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': 'ãƒã‚¤ãƒ“ãƒ¼', 'å‡ºèº«': 'ã‚¢ãƒ¡ãƒªã‚« ãƒ¯ã‚·ãƒ³ãƒˆãƒ³å·', 'æ€§æ ¼': ['æœ«ã£å­', 'ãƒ‘ãƒ¯ãƒ•ãƒ«ãƒœãƒ¼ã‚«ãƒ«'], 'èƒ¸ã®ã‚µã‚¤ã‚º': 'Dã‚«ãƒƒãƒ—', 'é™°æ¯›': 'æ™®é€š' } },
        };
        // Initialize missing settings to prevent errors
        Object.values(membersData).forEach(member => {
            const defaultSettings = { 'ç”Ÿå¹´æœˆæ—¥': '', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼': '', 'å‡ºèº«': '', 'æ–¹è¨€': '', 'æ€§æ ¼': [], 'èº«é•·': '', 'ä½“é‡': '', 'èƒ¸ã®ã‚µã‚¤ã‚º': '', 'ä¹³é¦–ã®è‰²': '', 'é™°æ¯›': '', 'ã¾ã‚“ã“ã®è‰²': '', 'æ€§æ¬²': '', 'å¥½ããªä½“ä½': '', 'æ„Ÿåº¦': '', 'å¾—æ„ãªå‰æˆ¯': '' };
            member.settings = { ...defaultSettings, ...member.settings };
        });


        let currentMemberId = null;
        let chatHistory = {}; // { memberId: [{ type: 'ai'/'user', text: '...', senderName: 'ãƒã‚³' (for AI) }] }

        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const talkListScreen = document.getElementById('talk-list-screen');
        const memberListUl = document.getElementById('member-list');
        const navCommonSettingsBtn = document.getElementById('nav-common-settings');
        const navTalkBtn = document.getElementById('nav-talk');
        const navProfileBtn = document.getElementById('nav-profile');

        const chatScreen = document.getElementById('chat-screen');
        const chatBackToListBtn = document.getElementById('chat-back-to-list');
        const chatMemberNameH2 = document.getElementById('chat-member-name');
        const chatNewTalkBtn = document.getElementById('chat-new-talk');
        const chatMenuBtn = document.getElementById('chat-menu');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const replySuggestionsDiv = document.getElementById('reply-suggestions');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message');

        const memberSettingsScreen = document.getElementById('member-settings-screen');
        const settingsBackToChatBtn = document.getElementById('settings-back-to-chat');
        const settingsMemberNameH2 = document.getElementById('settings-member-name');
        const settingsMemberIconDiv = document.getElementById('settings-member-icon');
        const basicSettingsContainer = document.getElementById('basic-settings-container');
        const sexualSettingsContainer = document.getElementById('sexual-settings-container');

        const commonSettingsScreen = document.getElementById('common-settings-screen');
        const profileScreen = document.getElementById('profile-screen');
        const backToTalkListBtns = document.querySelectorAll('.back-to-talk-list');


        // --- Navigation ---
        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            // Update footer active state for main screens
            if (screenId === 'talk-list-screen') {
                navTalkBtn.classList.add('active');
                navCommonSettingsBtn.classList.remove('active');
                navProfileBtn.classList.remove('active');
            } else if (screenId === 'common-settings-screen') {
                navCommonSettingsBtn.classList.add('active');
                navTalkBtn.classList.remove('active');
                navProfileBtn.classList.remove('active');
            } else if (screenId === 'profile-screen') {
                navProfileBtn.classList.add('active');
                navTalkBtn.classList.remove('active');
                navCommonSettingsBtn.classList.remove('active');
            }
        }

        // --- Rendering ---
        function renderMemberList() {
            memberListUl.innerHTML = '';
            Object.values(membersData).forEach(member => {
                const li = document.createElement('li');
                li.className = 'member-item';
                li.dataset.memberId = member.id;

                const iconDiv = document.createElement('div');
                iconDiv.className = 'member-icon-container';
                iconDiv.style.borderColor = memberRingColors[member.name] || '#ccc';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'member-name';
                nameSpan.textContent = member.name;

                const countDiv = document.createElement('div');
                countDiv.className = 'member-message-count';
                countDiv.innerHTML = `<span class="icon">ğŸ’¬</span> ${member.msgCount}`;

                // Click on member name/icon area
                const mainClickArea = document.createElement('div');
                mainClickArea.style.display = 'flex';
                mainClickArea.style.alignItems = 'center';
                mainClickArea.style.flexGrow = '1';
                mainClickArea.appendChild(iconDiv);
                mainClickArea.appendChild(nameSpan);
                mainClickArea.addEventListener('click', () => openChat(member.id, true)); // true for new talk

                // Click on message count area
                countDiv.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent li click
                    openChat(member.id, false); // false for existing/past talk
                });

                li.appendChild(mainClickArea);
                li.appendChild(countDiv);
                memberListUl.appendChild(li);
            });
        }

        function renderChatMessages() {
            chatMessagesContainer.innerHTML = '';
            if (!currentMemberId || !chatHistory[currentMemberId]) {
                // Add a placeholder if no history
                const placeholder = document.createElement('p');
                placeholder.textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                placeholder.style.textAlign = 'center';
                placeholder.style.color = '#aaa';
                chatMessagesContainer.appendChild(placeholder);
                return;
            }

            chatHistory[currentMemberId].forEach((msg, index) => {
                const bubbleWrapper = document.createElement('div');
                if (msg.type === 'ai') {
                    const member = membersData[currentMemberId];
                    bubbleWrapper.className = 'ai-meta';

                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'ai-icon-chat';
                    iconDiv.style.borderColor = memberRingColors[member.name] || '#ccc';
                    bubbleWrapper.appendChild(iconDiv);

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'ai-name-chat';
                    nameSpan.textContent = msg.senderName || member.name;
                    bubbleWrapper.appendChild(nameSpan);
                }

                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${msg.type}`;
                bubble.textContent = msg.text;
                bubble.dataset.messageIndex = index;


                if (msg.type === 'ai') {
                     // Click for "swipe to regenerate" placeholder
                    bubble.addEventListener('click', () => {
                        alert(`AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œ${msg.text}ã€ã‚’å†ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ (ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã¯UIãƒ‡ãƒ¢ã®ãŸã‚ã‚¯ãƒªãƒƒã‚¯ã§ä»£æ›¿)`);
                        // Here you would call AI to regenerate
                    });
                    // Append bubble to wrapper, then wrapper to container
                    const aiMessageContainer = document.createElement('div'); // To group icon/name and bubble correctly
                    aiMessageContainer.style.alignSelf = 'flex-start';
                    aiMessageContainer.appendChild(bubbleWrapper);
                    aiMessageContainer.appendChild(bubble);
                    chatMessagesContainer.appendChild(aiMessageContainer);

                } else { // user message
                    bubble.addEventListener('mousedown', (e) => { // Simulate long press
                        let pressTimer = window.setTimeout(() => {
                            alert(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œ${msg.text}ã€ã‚’ç·¨é›†ã—ã¾ã™ã‹ï¼Ÿ\n(ç·¨é›†ã™ã‚‹ã¨ä»¥é™ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚¯ãƒªã‚¢ã•ã‚Œã€AIãŒå†ç”Ÿæˆã—ã¾ã™ - UIãƒ‡ãƒ¢)`);
                            // Implement actual editing UI and logic here
                        }, 1000); // 1 second for long press
                        bubble.addEventListener('mouseup', () => clearTimeout(pressTimer));
                        bubble.addEventListener('mouseleave', () => clearTimeout(pressTimer));
                    });
                    chatMessagesContainer.appendChild(bubble);
                }
            });
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
        }

        function renderMemberSettings() {
            if (!currentMemberId) return;
            const member = membersData[currentMemberId];
            settingsMemberNameH2.textContent = `${member.name} è¨­å®š`;
            settingsMemberIconDiv.style.borderColor = memberRingColors[member.name] || '#ccc';

            basicSettingsContainer.innerHTML = '';
            sexualSettingsContainer.innerHTML = '';

            const createSettingItem = (key, value, category) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'setting-item';
                const labelSpan = document.createElement('span');
                labelSpan.className = 'label';
                labelSpan.textContent = key;

                const valueDiv = document.createElement('div');

                if (Array.isArray(value)) { // For æ€§æ ¼ etc.
                    valueDiv.className = 'value multi-value';
                    value.forEach(v => {
                        const valSpan = document.createElement('span');
                        valSpan.textContent = v;
                        valueDiv.appendChild(valSpan);
                    });
                } else {
                    valueDiv.className = 'value';
                    valueDiv.textContent = value || 'æœªè¨­å®š'; // Show 'æœªè¨­å®š' for empty strings
                }
                 // Simple input for demonstration on click. In a real app, use modals or inline editing.
                valueDiv.addEventListener('click', () => {
                    const newValue = prompt(`ã€Œ${key}ã€ã®æ–°ã—ã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, Array.isArray(value) ? value.join(', ') : value);
                    if (newValue !== null) {
                        // Basic update, no type checking or complex array handling here for brevity
                        membersData[currentMemberId].settings[key] = Array.isArray(value) ? newValue.split(',').map(s => s.trim()) : newValue;
                        // TODO: Save to localStorage
                        renderMemberSettings(); // Re-render to show changes
                        alert("è¨­å®šãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼ˆå®Ÿéš›ã«ã¯ä¿å­˜å‡¦ç†ãŒå¿…è¦ã§ã™ï¼‰ã€‚ä»–ã®ãƒˆãƒ¼ã‚¯ã«ã‚‚é©ç”¨ã•ã‚Œã¾ã™ã€‚");
                    }
                });


                itemDiv.appendChild(labelSpan);
                itemDiv.appendChild(valueDiv);
                if (['ç”Ÿå¹´æœˆæ—¥', 'ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼', 'å‡ºèº«', 'æ–¹è¨€', 'æ€§æ ¼', 'èº«é•·', 'ä½“é‡'].includes(key)) {
                    basicSettingsContainer.appendChild(itemDiv);
                } else {
                    sexualSettingsContainer.appendChild(itemDiv);
                }
            };

            for (const [key, value] of Object.entries(member.settings)) {
                createSettingItem(key, value);
            }
        }

        // --- Actions ---
        function openChat(memberId, isNewTalk) {
            currentMemberId = memberId;
            const member = membersData[memberId];
            chatMemberNameH2.textContent = member.name;

            if (isNewTalk) {
                // For a truly new talk, you might assign a new talk ID
                // For this demo, "new talk" might mean clearing history or starting fresh if no history
                if (!chatHistory[memberId] || confirm(`${member.name}ã¨ã®æ–°ã—ã„ãƒˆãƒ¼ã‚¯ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿï¼ˆç¾åœ¨ã®å±¥æ­´ã¯ä¿æŒã•ã‚Œã¾ã™ãŒã€è¡¨ç¤ºä¸Šã¯æ–°è¦ã«ãªã‚Šã¾ã™ï¼‰`)) {
                     // If truly new, you might not load any history.
                     // For demo, let's make "new talk" from list screen just open the chat.
                     // The "new talk" button on chat screen will handle clearing.
                }
            }

            // Initialize chat history for the member if it doesn't exist
            if (!chatHistory[memberId]) {
                chatHistory[memberId] = [
                    { type: 'ai', text: `ã“ã‚“ã«ã¡ã¯ï¼${member.name}ã ã‚ˆã€‚`, senderName: member.name },
                    // Add more initial messages if desired
                ];
            }
            renderChatMessages();
            showScreen('chat-screen');
        }

        function handleSendMessage() {
            const text = messageInput.value.trim();
            if (text === '' || !currentMemberId) return;

            chatHistory[currentMemberId].push({ type: 'user', text: text });
            messageInput.value = '';
            renderChatMessages();

            // Simulate AI reply
            setTimeout(() => {
                const member = membersData[currentMemberId];
                // Basic AI response placeholder
                let aiResponse = "ã†ã‚“ã†ã‚“ã€ãã‚Œã§ï¼Ÿ";
                if (text.includes("å¥½ã")) aiResponse = "ç§ã‚‚ã ã‚ˆï¼å¬‰ã—ã„ãªğŸ˜Š";
                else if (text.includes("ä½•ã—ã¦ã‚‹")) aiResponse = "å›ã¨ãŠè©±ã—ã¦ã‚‹ã‚ˆï¼";

                chatHistory[currentMemberId].push({ type: 'ai', text: aiResponse, senderName: member.name });
                renderChatMessages();
            }, 1000);
        }

        // --- Event Listeners ---
        navCommonSettingsBtn.addEventListener('click', () => showScreen('common-settings-screen'));
        navTalkBtn.addEventListener('click', () => showScreen('talk-list-screen'));
        navProfileBtn.addEventListener('click', () => showScreen('profile-screen'));
        backToTalkListBtns.forEach(btn => btn.addEventListener('click', () => showScreen('talk-list-screen')));


        chatBackToListBtn.addEventListener('click', () => showScreen('talk-list-screen'));
        chatNewTalkBtn.addEventListener('click', () => {
            if (currentMemberId && confirm(`${membersData[currentMemberId].name}ã¨ã®ç¾åœ¨ã®ä¼šè©±ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„ãƒˆãƒ¼ã‚¯ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ`)) {
                chatHistory[currentMemberId] = [ { type: 'ai', text: `æ”¹ã‚ã¦ã€ã“ã‚“ã«ã¡ã¯ï¼${membersData[currentMemberId].name}ã ã‚ˆã€‚`, senderName: membersData[currentMemberId].name }];
                renderChatMessages();
                alert("æ–°ã—ã„ãƒˆãƒ¼ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
            }
        });
        chatMenuBtn.addEventListener('click', () => {
            if (currentMemberId) {
                renderMemberSettings();
                showScreen('member-settings-screen');
            }
        });

        sendMessageBtn.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSendMessage();
        });

        replySuggestionsDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-btn')) {
                messageInput.value += (messageInput.value ? ' ' : '') + e.target.textContent;
                messageInput.focus();
            }
        });

        settingsBackToChatBtn.addEventListener('click', () => {
            if (currentMemberId) showScreen('chat-screen');
        });


        // --- Initialization ---
        renderMemberList();
        // Load data from localStorage if available (conceptual)
        // loadDataFromLocalStorage();
    </script>
</body>
</html>
