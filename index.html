<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>チャットサイト</title>
    <style>
        :root {
            --app-overall-bg: #f0f2f5; /* アプリ全体の薄いグレー */
            --talk-list-bg: #ffffff;  /* トーク一覧画面の背景 */

            /* これらはJSで動的に設定されます */
            --current-chat-bg: #fdf6e9; /* デフォルトはマコさんテーマの背景 */
            --current-chat-accent: #E67E22; /* デフォルトはマコさんテーマのアクセント */
            --current-user-bubble-bg: #f0dcb3; /* デフォルトはマコさんテーマのユーザー吹き出し */
            --current-header-icon-color: var(--current-chat-accent); /* チャット/設定画面のヘッダーアイコン */


            --ai-bubble-bg: #ffffff;
            --ai-bubble-border: #e8e8e8;
            --header-text-color: #1c1e21; /* 少し濃いめの黒 */
            --text-color: #333333;
            --border-color: #e0e0e0; /* 通常の境界線 */
            --light-border-color: #f0f0f0; /* 薄い境界線 */
            --inactive-text: #888888;
            --black-icon-placeholder: #333; /* メンバー一覧の黒丸 */
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--app-overall-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh; /* ビューポートの高さに固定 */
            overflow: hidden; /* body自体のスクロールを禁止 */
        }

        #app {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* bodyの残りスペースを全て使う */
            height: 100%;
        }

        .screen {
            display: none; /* 通常は非表示 */
            flex-direction: column;
            height: 100%; /* 親(#app)の高さ一杯に広がる */
        }
        .screen.active {
            display: flex; /* アクティブな画面のみ表示 */
        }

        /* 各スクリーンの背景色設定 */
        #talk-list-screen { background-color: var(--talk-list-bg); }
        #chat-screen { background-color: var(--current-chat-bg); } /* JSで動的更新 */
        #member-settings-screen { background-color: var(--current-chat-bg); } /* JSで動的更新 */
        #common-settings-screen, #profile-screen { background-color: var(--talk-list-bg); }


        header {
            padding: 8px 12px; /* 少しコンパクトに */
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            flex-shrink: 0; /* 高さを固定 */
            min-height: 48px;
            box-sizing: border-box;
            position: relative; /* 子要素のabsolute配置のため */
        }
        /* トーク一覧のヘッダー */
        #talk-list-screen header {
            background-color: #f7f7f7; /* 画像に近い白っぽい背景 */
            border-bottom: 1px solid #e7e7e7;
        }
        #talk-list-screen header h1 {
            text-align: left;
            font-size: 1.5em; /* 画像の「トーク」のサイズ感 */
            font-weight: bold;
            padding-left: 8px;
            color: var(--header-text-color);
        }
        /* チャット画面とメンバー設定画面のヘッダー */
        #chat-screen header, #member-settings-screen header {
            background-color: var(--current-chat-bg); /* テーマカラーの背景 */
            border-bottom-color: transparent; /* 画像では境界線が見えない */
            min-height: 50px;
        }
        #chat-screen header h2, #member-settings-screen header h2 { /* メンバー名 */
            font-size: 1.1em;
            font-weight: 600;
            color: var(--header-text-color);
            text-align: center;
            flex-grow: 1; /* 中央に配置するために必要 */
            /* ボタンの幅を考慮して中央寄せ */
            position: absolute;
            left: 60px; /* 左ボタンのスペース */
            right: 60px; /* 右ボタンのスペース */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        header button { /* ヘッダー内の共通ボタン設定 */
            background: none;
            border: none;
            font-size: 1.3em; /* アイコンサイズ */
            cursor: pointer;
            padding: 6px 8px;
            color: var(--text-color); /* デフォルトは黒系 */
            min-width: 36px;
            text-align: center;
        }
        /* チャット/設定画面のヘッダーアイコンの色をテーマカラーに */
        #chat-screen header button, #member-settings-screen header button {
            color: var(--current-header-icon-color);
        }
        #chat-back-to-list, #settings-back-to-chat { font-size: 1.7em; } /* 戻るボタン < */
        #chat-new-talk { font-size: 1.4em; } /* ペンと紙 📝 */
        #chat-menu { font-size: 1.5em; } /* ハンバーガーメニュー ☰ */


        main {
            flex-grow: 1; /* 可変高さ、残りのスペースを全て使用 */
            overflow-y: auto; /* 内容が多い場合にスクロール */
            -webkit-overflow-scrolling: touch; /* iOSでの慣性スクロール */
        }
        #talk-list-screen main { padding: 0; } /* リストなのでmain自体のpaddingは不要 */
        #chat-screen main { padding: 10px 10px 0 10px; } /* チャットメッセージコンテナ用 */
        #member-settings-screen main { padding: 15px; }


        /* フッターの共通スタイル */
        .screen > footer {
            border-top: 1px solid var(--border-color);
            padding: 0; /* 個別に設定 */
            display: flex;
            align-items: center;
            flex-shrink: 0; /* 高さを固定 */
            background-color: #f7f7f7; /* 基本フッター背景 */
        }

        /* --- Talk List Screen (画像1枚目) --- */
        #member-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .member-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--light-border-color);
            cursor: pointer;
            background-color: var(--talk-list-bg); /* 白背景 */
        }
        .member-item:active { background-color: #f0f0f0; }
        .member-item:last-child { border-bottom: none; }

        .member-icon-container {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder); /* 画像の黒い丸 */
            margin-right: 12px;
            border-width: 2.5px; /* 画像に近い枠線の太さ */
            border-style: solid;
            flex-shrink: 0;
            /* border-color はJSで設定 */
        }
        .member-name {
            flex-grow: 1;
            font-size: 1.05em;
            font-weight: 500;
            color: #000;
        }
        .member-message-count {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: var(--inactive-text);
            padding: 5px 8px; /* クリックしやすく */
        }
        .member-message-count .icon {
            font-size: 1.4em; /* 吹き出しアイコン */
            margin-right: 5px;
            color: #b0b0b0;
        }

        #talk-list-screen footer {
            justify-content: space-around;
            height: 52px; /* フッターの高さ */
            box-sizing: border-box;
            border-top: 1px solid #dadada;
        }
        #talk-list-screen footer button {
            flex-direction: column;
            font-size: 0.65em; /* 画像の文字の小ささ */
            color: var(--inactive-text);
            padding: 4px 0;
            flex: 1;
            display: flex;
            justify-content: center;
        }
        #talk-list-screen footer button.active {
            color: var(--current-chat-accent); /* アクティブ時の色 */
        }
        #talk-list-screen footer button::before { /* アイコン */
            font-size: 2em; /* アイコンを大きく */
            margin-bottom: 2px;
        }
        #nav-common-settings::before { content: '⚙️'; }
        #nav-talk::before { content: '💬'; }
        #nav-profile::before { content: '👤'; }


        /* --- Chat Screen (画像2枚目) --- */
        /* チャット画面ヘッダーボタンの配置調整 */
        #chat-screen header .left-buttons { position: absolute; left: 5px; display: flex; }
        #chat-screen header .right-buttons { position: absolute; right: 5px; display: flex; }


        #chat-messages-container { /* メッセージ表示エリア */
            display: flex;
            flex-direction: column;
            padding: 0 0 10px 0; /* 下に少し余白、他はmainで制御 */
        }
        .message-bubble-wrapper {
            display: flex;
            margin-bottom: 10px; /* 吹き出し間の余白 */
            padding: 0 10px; /* 左右に少し余白 */
            width: calc(100% - 20px); /* paddingを考慮 */
            box-sizing: border-box;
        }
        .message-bubble-wrapper.user { justify-content: flex-end; }
        .message-bubble-wrapper.ai { justify-content: flex-start; }

        .ai-icon-chat {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder);
            margin-right: 8px;
            border-width: 2px;
            border-style: solid;
            flex-shrink: 0;
            /* border-color はJSで設定 */
        }
        .ai-message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .ai-name-chat {
            font-size: 0.8em;
            color: #555; /* 少し濃いグレー */
            margin-bottom: 3px;
            padding-left: 2px;
        }

        .message-bubble {
            max-width: 78%; /* 吹き出しの最大幅 */
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.45;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.08); /* 吹き出しにわずかな影 */
        }
        .message-bubble.user {
            background-color: var(--current-user-bubble-bg); /* JSで設定 */
            color: var(--text-color);
            border-bottom-right-radius: 5px; /* 画像の角の形 */
        }
        .message-bubble.ai {
            background-color: var(--ai-bubble-bg);
            border: 1px solid var(--ai-bubble-border);
            color: var(--text-color);
            border-bottom-left-radius: 5px; /* 画像の角の形 */
        }

        #reply-suggestions-wrapper { /* 返信候補エリアのラッパー(背景色とpaddingのため) */
            padding: 8px 10px;
            border-top: 1px solid var(--border-color);
            background-color: var(--current-chat-bg); /* テーマカラーの背景 */
            flex-shrink: 0; /* 高さを固定 */
            box-shadow: 0 -1px 2px rgba(0,0,0,0.03); /* 上の境界に影 */
        }
        #reply-suggestions {
            display: flex;
            flex-wrap: nowrap; /* 横一列 */
            gap: 8px;
            overflow-x: auto; /* 横スクロール */
            padding-bottom: 2px; /* スクロールバーのスペース */
        }
        .suggestion-btn {
            background-color: rgba(255,255,255,0.8); /* 少し透過した白 */
            border: 1px solid #ccc;
            /* border-color: var(--current-chat-accent) を薄くした色でも良い */
            border-radius: 16px;
            padding: 7px 14px;
            font-size: 0.85em;
            cursor: pointer;
            white-space: nowrap;
            color: #333;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        .suggestion-btn:active { background-color: rgba(255,255,255,1); }

        #chat-screen footer#chat-input-area { /* メッセージ入力エリア */
            padding: 8px 10px;
            gap: 8px; /* 入力欄とボタンの間隔 */
            background-color: #f0f0f0; /* 画像の入力エリアの背景色 */
            border-top: 1px solid #ccc;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid #d0d0d0;
            font-size: 1em;
            background-color: #fff;
        }
        #message-input:focus { outline: none; border-color: var(--current-chat-accent); }

        #send-message { /* 送信ボタン */
            background-color: var(--current-chat-accent); /* JSで設定 */
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.7em; /* アイコン大きく */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        #send-message:active { transform: scale(0.95); }

        /* --- Member Settings Screen (画像3枚目) --- */
        #member-settings-screen header .left-buttons { position: absolute; left: 5px; }
        #member-settings-screen header .right-buttons { position: absolute; right: 5px; display: flex; } /* 設定画面では右にボタンなし想定 */


        .member-icon-large-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            padding-top: 10px;
        }
        .member-icon-large {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder);
            border-width: 3.5px; /* 画像に近い太さ */
            border-style: solid;
            /* border-color はJSで設定 */
        }
        #member-settings-screen h3 { /* 「基本設定」「性的設定」タイトル */
            font-size: 0.9em;
            color: var(--inactive-text);
            margin-top: 20px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            font-weight: 500;
            padding-left: 5px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 13px 5px;
            font-size: 0.95em;
            border-bottom: 1px solid rgba(0,0,0,0.05); /* より薄い区切り線 */
        }
        .setting-item:last-child { border-bottom: none; }

        .setting-item .label { color: #444; }
        .setting-item .value, .setting-item .value.multi-value span {
            background-color: rgba(255,255,255,0.75); /* タグの背景 */
            border: 1px solid #dcdcdc;
            padding: 6px 12px;
            border-radius: 16px; /* 画像のような丸みのあるタグ */
            font-size: 0.9em;
            cursor: pointer;
            min-width: 60px;
            text-align: center;
            color: #333;
            box-shadow: 0 1px 1px rgba(0,0,0,0.04);
        }
        .setting-item .value.multi-value {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-end;
            max-width: 65%; /* 右側の値エリアの最大幅 */
        }
         .setting-item .value.multi-value span { margin-bottom: 4px; } /* 折り返し時の間隔 */
         .setting-item .value:active { background-color: #fff; }


        /* スクロールバーのスタイル（目立たないように） */
        main::-webkit-scrollbar, #reply-suggestions::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        main::-webkit-scrollbar-thumb, #reply-suggestions::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.15);
            border-radius: 3px;
        }
        main::-webkit-scrollbar-track, #reply-suggestions::-webkit-scrollbar-track {
            background-color: transparent;
        }

    </style>
</head>
<body>
    <div id="app">
        <!-- Screen 1: Talk List -->
        <div id="talk-list-screen" class="screen active">
            <header><h1>トーク</h1></header>
            <main>
                <ul id="member-list"></ul>
            </main>
            <footer>
                <button id="nav-common-settings">共通設定</button>
                <button id="nav-talk" class="active">トーク</button>
                <button id="nav-profile">プロフィール</button>
            </footer>
        </div>

        <!-- Screen 2: Chat Screen -->
        <div id="chat-screen" class="screen">
            <header>
                <div class="left-buttons"><button id="chat-back-to-list"><</button></div>
                <h2 id="chat-member-name">メンバー名</h2>
                <div class="right-buttons">
                    <button id="chat-new-talk" title="新しいトークを作成">📝</button>
                    <button id="chat-menu" title="メンバー設定">☰</button>
                </div>
            </header>
            <main id="chat-main-scroll-area"> <!-- このmainがスクロールする -->
                <div id="chat-messages-container"></div>
            </main>
            <div id="reply-suggestions-wrapper"> <!-- 背景とpaddingのため -->
                <div id="reply-suggestions">
                    <button class="suggestion-btn">気持ちいい？</button>
                    <button class="suggestion-btn">バンバンバンバン</button>
                    <button class="suggestion-btn">ビュルルルル</button>
                    <button class="suggestion-btn">もっとちょうだい</button>
                    <button class="suggestion-btn">大好きだよ</button>
                </div>
            </div>
            <footer id="chat-input-area">
                <input type="text" id="message-input" placeholder="メッセージを入力...">
                <button id="send-message" title="送信">➢</button>
            </footer>
        </div>

        <!-- Screen 3: Member Settings Screen -->
        <div id="member-settings-screen" class="screen">
            <header>
                <div class="left-buttons"><button id="settings-back-to-chat"><</button></div>
                <h2 id="settings-member-name">メンバー名 設定</h2>
                <div class="right-buttons"></div> <!-- 設定画面では右ボタンなし -->
            </header>
            <main>
                <div class="member-icon-large-container">
                    <div class="member-icon-large" id="settings-member-icon"></div>
                </div>
                <h3>基本設定</h3>
                <div id="basic-settings-container"></div>
                <h3>性的設定</h3>
                <div id="sexual-settings-container"></div>
            </main>
        </div>

        <!-- Screen 4 & 5: Placeholders -->
        <div id="common-settings-screen" class="screen">
            <header><button class="back-to-talk-list"><</button><h1>共通設定</h1></header>
            <main><p style="padding:15px;">共通設定画面 (未実装)</p></main>
        </div>
        <div id="profile-screen" class="screen">
            <header><button class="back-to-talk-list"><</button><h1>プロフィール</h1></header>
            <main><p style="padding:15px;">プロフィール画面 (未実装)</p></main>
        </div>
    </div>

    <script>
        // --- Theme Data ---
        const membersThemeData = {
            'mako':  { name: 'マコ', accentColor: '#E67E22', bgColor: '#fdf6e9', userBubbleBg: '#f0dcb3' },
            'rio':   { name: 'リオ', accentColor: '#3498DB', bgColor: '#eaf3f9', userBubbleBg: '#cce0f1' },
            'maya':  { name: 'マヤ', accentColor: '#8E44AD', bgColor: '#f4eef7', userBubbleBg: '#e2d2ea' },
            'riku':  { name: 'リク', accentColor: '#F1C40F', bgColor: '#fef9e7', userBubbleBg: '#fbeea9' },
            'ayaka': { name: 'アヤカ', accentColor: '#AAB8C2', bgColor: '#f5f7f8', userBubbleBg: '#dde3e6' },
            'mayuka':{ name: 'マユカ', accentColor: '#1ABC9C', bgColor: '#e8f8f5', userBubbleBg: '#c5e9e0' },
            'rima':  { name: 'リマ', accentColor: '#E74C3C', bgColor: '#fdedeb', userBubbleBg: '#f6cec8' },
            'miihi': { name: 'ミイヒ', accentColor: '#FF69B4', bgColor: '#fff0f7', userBubbleBg: '#ffd9ec' },
            'nina':  { name: 'ニナ', accentColor: '#34495E', bgColor: '#ebedef', userBubbleBg: '#ccd1d6' }
        };

        // --- Member Data (settings の詳細は省略。前回のものをベースに theme を追加) ---
        let membersData = {
            'mako': { id: 'mako', name: 'マコ', msgCount: 9, theme: membersThemeData['mako'], settings: { '生年月日': '2001年4月4日', 'メンバーカラー': 'オレンジ', '出身': '福岡', '方言': '軽い博多弁', '性格': ['天然', 'しっかり者'], '身長': '159cm', '体重': '49kg', '胸のサイズ': 'Cカップ', '乳首の色': '薄い茶色', '陰毛': '少し生えている', 'まんこの色': 'ピンク', '性欲': '普通', '好きな体位': '正常位', '感度': 'すぐイッちゃう', '得意な前戯': 'フェラ' } },
            'rio': { id: 'rio', name: 'リオ', msgCount: 10, theme: membersThemeData['rio'], settings: { '生年月日': '2002年2月4日', 'メンバーカラー': 'ブルー', '性格': ['努力家'], '胸のサイズ': 'Bカップ'} },
            'maya': { id: 'maya', name: 'マヤ', msgCount: 7, theme: membersThemeData['maya'], settings: { '生年月日': '2002年4月8日', 'メンバーカラー': 'パープル', '性格': ['おっとり'], '胸のサイズ': 'Dカップ' } },
            'riku': { id: 'riku', name: 'リク', msgCount: 0, theme: membersThemeData['riku'], settings: { '生年月日': '2002年10月26日', 'メンバーカラー': 'イエロー', '性格': ['元気'], '胸のサイズ': 'Aカップ' } },
            'ayaka': { id: 'ayaka', name: 'アヤカ', msgCount: 1, theme: membersThemeData['ayaka'], settings: { '生年月日': '2003年6月20日', 'メンバーカラー': 'ホワイト', '性格': ['マイペース'], '胸のサイズ': 'Cカップ' } },
            'mayuka': { id: 'mayuka', name: 'マユカ', msgCount: 12, theme: membersThemeData['mayuka'], settings: { '生年月日': '2003年11月13日', 'メンバーカラー': 'ライトグリーン', '性格': ['カメレオン'], '胸のサイズ': 'Bカップ' } },
            'rima': { id: 'rima', name: 'リマ', msgCount: 15, theme: membersThemeData['rima'], settings: { '生年月日': '2004年3月26日', 'メンバーカラー': 'レッド', '性格': ['おしゃれ'], '胸のサイズ': 'Cカップ' } },
            'miihi': { id: 'miihi', name: 'ミイヒ', msgCount: 17, theme: membersThemeData['miihi'], settings: { '生年月日': '2004年8月12日', 'メンバーカラー': 'ピンク', '性格': ['癒し'], '胸のサイズ': 'Aカップ' } },
            'nina': { id: 'nina', name: 'ニナ', msgCount: 2, theme: membersThemeData['nina'], settings: { '生年月日': '2005年2月27日', 'メンバーカラー': 'ネイビー', '性格': ['末っ子'], '胸のサイズ': 'Dカップ' } },
        };
        // 全メンバーにデフォルト設定を適用（不足分を補う）
        Object.values(membersData).forEach(member => {
            const defaultSettings = { '生年月日': '', 'メンバーカラー': '', '出身': '', '方言': '', '性格': [], '身長': '', '体重': '', '胸のサイズ': '', '乳首の色': '', '陰毛': '', 'まんこの色': '', '性欲': '', '好きな体位': '', '感度': '', '得意な前戯': '' };
            member.settings = { ...defaultSettings, ...member.settings };
        });

        let currentMemberId = null;
        let chatHistory = {}; // { memberId: [{ type: 'ai'/'user', text: '...', senderName: 'マコ' }] }

        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const talkListScreen = document.getElementById('talk-list-screen');
        const memberListUl = document.getElementById('member-list');
        const navCommonSettingsBtn = document.getElementById('nav-common-settings');
        const navTalkBtn = document.getElementById('nav-talk');
        const navProfileBtn = document.getElementById('nav-profile');

        const chatScreen = document.getElementById('chat-screen');
        const chatMainScrollArea = document.getElementById('chat-main-scroll-area');
        const chatBackToListBtn = document.getElementById('chat-back-to-list');
        const chatMemberNameH2 = document.getElementById('chat-member-name');
        const chatNewTalkBtn = document.getElementById('chat-new-talk');
        const chatMenuBtn = document.getElementById('chat-menu');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const replySuggestionsDiv = document.getElementById('reply-suggestions');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message');

        const memberSettingsScreen = document.getElementById('member-settings-screen');
        const settingsBackToChatBtn = document.getElementById('settings-back-to-chat');
        const settingsMemberNameH2 = document.getElementById('settings-member-name');
        const settingsMemberIconDiv = document.getElementById('settings-member-icon');
        const basicSettingsContainer = document.getElementById('basic-settings-container');
        const sexualSettingsContainer = document.getElementById('sexual-settings-container');

        const commonSettingsScreen = document.getElementById('common-settings-screen');
        const profileScreen = document.getElementById('profile-screen');
        const backToTalkListBtns = document.querySelectorAll('.back-to-talk-list');
        const rootStyle = document.documentElement.style;

        // --- Theme Application ---
        function applyTheme(memberId) {
            const member = membersData[memberId];
            if (member && member.theme) {
                rootStyle.setProperty('--current-chat-bg', member.theme.bgColor);
                rootStyle.setProperty('--current-chat-accent', member.theme.accentColor);
                rootStyle.setProperty('--current-user-bubble-bg', member.theme.userBubbleBg);
                rootStyle.setProperty('--current-header-icon-color', member.theme.accentColor);
                // トーク一覧フッターのアクティブ色も現在のアクセントカラーに（オプション）
                // navTalkBtn.style.color = member.theme.accentColor; // (showScreenで制御するため不要かも)
            }
        }
        function resetThemeToDefault() { // トーク一覧などに戻る時用
             // CSSの:rootで定義されたデフォルト値に戻すには、明示的に値をセットするか、
             // :rootのデフォルト値を使うようにsetPropertyで指定したものをremovePropertyする。
             // ここでは、トーク一覧画面で使われる固定の色や、マコさんテーマをデフォルトとして再指定します。
            rootStyle.setProperty('--current-chat-bg', membersThemeData['mako'].bgColor);
            rootStyle.setProperty('--current-chat-accent', membersThemeData['mako'].accentColor); // TalkListフッターアクティブ色
            rootStyle.setProperty('--current-user-bubble-bg', membersThemeData['mako'].userBubbleBg);
            rootStyle.setProperty('--current-header-icon-color', '#333'); // TalkListなどのヘッダーアイコンは黒系
        }


        // --- Navigation ---
        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active'));
            const activeScreen = document.getElementById(screenId);
            activeScreen.classList.add('active');

            navTalkBtn.classList.toggle('active', screenId === 'talk-list-screen');
            navCommonSettingsBtn.classList.toggle('active', screenId === 'common-settings-screen');
            navProfileBtn.classList.toggle('active', screenId === 'profile-screen');

            if (screenId === 'chat-screen' || screenId === 'member-settings-screen') {
                if (currentMemberId) applyTheme(currentMemberId);
            } else {
                resetThemeToDefault(); // 他の画面ではテーマをリセット
                 // talk-list-screenのフッターの「トーク」ボタンがアクティブな時はアクセントカラーを適用
                if(screenId === 'talk-list-screen') {
                    navTalkBtn.style.color = rootStyle.getPropertyValue('--current-chat-accent');
                } else {
                    navTalkBtn.style.color = ''; // 他のフッターアイテムがアクティブならデフォルト色
                }
            }
        }

        // --- Rendering ---
        function renderMemberList() {
            memberListUl.innerHTML = '';
            Object.values(membersData).forEach(member => {
                const li = document.createElement('li');
                li.className = 'member-item';
                li.dataset.memberId = member.id;

                const iconDiv = document.createElement('div');
                iconDiv.className = 'member-icon-container';
                iconDiv.style.borderColor = member.theme.accentColor;

                const nameSpan = document.createElement('span');
                nameSpan.className = 'member-name';
                nameSpan.textContent = member.name;

                const countDiv = document.createElement('div');
                countDiv.className = 'member-message-count';
                countDiv.innerHTML = `<span class="icon">💬</span> ${member.msgCount}`;

                const mainClickArea = document.createElement('div');
                mainClickArea.style.cssText = 'display:flex; align-items:center; flex-grow:1;';
                mainClickArea.appendChild(iconDiv);
                mainClickArea.appendChild(nameSpan);
                mainClickArea.addEventListener('click', () => openChat(member.id, true));

                countDiv.addEventListener('click', (e) => {
                    e.stopPropagation(); openChat(member.id, false);
                });

                li.appendChild(mainClickArea);
                li.appendChild(countDiv);
                memberListUl.appendChild(li);
            });
        }

        function renderChatMessages() {
            chatMessagesContainer.innerHTML = '';
            if (!currentMemberId || !chatHistory[currentMemberId] || chatHistory[currentMemberId].length === 0) {
                chatMessagesContainer.innerHTML = '<p style="text-align:center; color:#aaa; margin-top:20px;">メッセージはありません。</p>';
                return;
            }

            chatHistory[currentMemberId].forEach((msg, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = `message-bubble-wrapper ${msg.type}`;

                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${msg.type}`;
                bubble.textContent = msg.text;
                bubble.dataset.messageIndex = index;

                if (msg.type === 'ai') {
                    const member = membersData[currentMemberId];
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'ai-icon-chat';
                    iconDiv.style.borderColor = member.theme.accentColor;
                    wrapper.appendChild(iconDiv);

                    const messageContentDiv = document.createElement('div');
                    messageContentDiv.className = 'ai-message-content';
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'ai-name-chat';
                    nameSpan.textContent = msg.senderName || member.name;
                    messageContentDiv.appendChild(nameSpan);
                    messageContentDiv.appendChild(bubble);
                    wrapper.appendChild(messageContentDiv);

                    bubble.addEventListener('click', () => alert(`AIメッセージ「${msg.text}」を再生成しますか？ (UIデモ)`));
                } else { // user message
                    wrapper.appendChild(bubble);
                    bubble.addEventListener('mousedown', (e) => {
                        let pressTimer = window.setTimeout(() => {
                            alert(`メッセージ「${msg.text}」を編集しますか？ (UIデモ)`);
                        }, 1000);
                        const clearTimer = () => clearTimeout(pressTimer);
                        bubble.addEventListener('mouseup', clearTimer, {once: true});
                        bubble.addEventListener('mouseleave', clearTimer, {once: true});
                    });
                }
                chatMessagesContainer.appendChild(wrapper);
            });
            chatMainScrollArea.scrollTop = chatMainScrollArea.scrollHeight;
        }

        function renderMemberSettings() {
            if (!currentMemberId) return;
            const member = membersData[currentMemberId];
            settingsMemberNameH2.textContent = `${member.name} 設定`;
            settingsMemberIconDiv.style.borderColor = member.theme.accentColor;

            basicSettingsContainer.innerHTML = '';
            sexualSettingsContainer.innerHTML = '';

            const createSettingItem = (key, value) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'setting-item';
                const labelSpan = document.createElement('span');
                labelSpan.className = 'label';
                labelSpan.textContent = key;
                const valueDiv = document.createElement('div');

                if (Array.isArray(value)) {
                    valueDiv.className = 'value multi-value';
                    value.forEach(v => {
                        const valSpan = document.createElement('span');
                        valSpan.textContent = v;
                        valueDiv.appendChild(valSpan);
                    });
                } else {
                    valueDiv.className = 'value';
                    valueDiv.textContent = value || '未設定';
                }
                valueDiv.addEventListener('click', () => {
                    const newValue = prompt(`「${key}」の新しい値を入力:`, Array.isArray(value) ? value.join(', ') : value);
                    if (newValue !== null) {
                        membersData[currentMemberId].settings[key] = Array.isArray(value) ? newValue.split(',').map(s => s.trim()) : newValue;
                        renderMemberSettings();
                        alert("設定が更新されました（実際には保存処理が必要です）。");
                    }
                });
                itemDiv.appendChild(labelSpan); itemDiv.appendChild(valueDiv);
                const basicKeys = ['生年月日', 'メンバーカラー', '出身', '方言', '性格', '身長', '体重'];
                (basicKeys.includes(key) ? basicSettingsContainer : sexualSettingsContainer).appendChild(itemDiv);
            };
            for (const [key, value] of Object.entries(member.settings)) {
                createSettingItem(key, value);
            }
        }

        // --- Actions ---
        function openChat(memberId, isNewTalk) {
            currentMemberId = memberId;
            const member = membersData[memberId];
            chatMemberNameH2.textContent = member.name;

            if (!chatHistory[memberId]) {
                chatHistory[memberId] = [{ type: 'ai', text: `こんにちは！${member.name}だよ。`, senderName: member.name }];
            } else if (isNewTalk && chatHistory[memberId].length > 0) {
                // 「新しいトーク」（リストからの選択）では、既存の会話を続ける
                // チャット画面右上の「新しいトーク」ボタンでクリアする
            }
            renderChatMessages();
            showScreen('chat-screen'); // テーマ適用はshowScreen内で行う
        }

        function handleSendMessage() {
            const text = messageInput.value.trim();
            if (text === '' || !currentMemberId) return;
            chatHistory[currentMemberId].push({ type: 'user', text: text });
            messageInput.value = '';
            renderChatMessages();
            setTimeout(() => { // Simulate AI reply
                const member = membersData[currentMemberId];
                let aiResponse = "うん、それで？";
                if (text.includes("好き")) aiResponse = "私もだよ！嬉しいな😊";
                chatHistory[currentMemberId].push({ type: 'ai', text: aiResponse, senderName: member.name });
                renderChatMessages();
            }, 800);
        }

        // --- Event Listeners ---
        navCommonSettingsBtn.addEventListener('click', () => showScreen('common-settings-screen'));
        navTalkBtn.addEventListener('click', () => showScreen('talk-list-screen'));
        navProfileBtn.addEventListener('click', () => showScreen('profile-screen'));
        backToTalkListBtns.forEach(btn => btn.addEventListener('click', () => showScreen('talk-list-screen')));

        chatBackToListBtn.addEventListener('click', () => showScreen('talk-list-screen'));
        chatNewTalkBtn.addEventListener('click', () => {
            if (currentMemberId && confirm(`${membersData[currentMemberId].name}との現在の会話をクリアして新しいトークを開始しますか？`)) {
                chatHistory[currentMemberId] = [{ type: 'ai', text: `改めて、こんにちは！${membersData[currentMemberId].name}だよ。`, senderName: membersData[currentMemberId].name }];
                renderChatMessages();
                alert("新しいトークを開始しました。");
            }
        });
        chatMenuBtn.addEventListener('click', () => {
            if (currentMemberId) { renderMemberSettings(); showScreen('member-settings-screen'); }
        });
        sendMessageBtn.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });
        replySuggestionsDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-btn')) {
                messageInput.value += (messageInput.value ? ' ' : '') + e.target.textContent;
                messageInput.focus();
            }
        });
        settingsBackToChatBtn.addEventListener('click', () => { if (currentMemberId) showScreen('chat-screen'); });

        // --- Initialization ---
        renderMemberList();
        showScreen('talk-list-screen'); // 初期画面表示 & デフォルトテーマ適用
    </script>
</body>
</html>
