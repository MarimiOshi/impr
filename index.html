<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÉÅ„É£„ÉÉ„Éà„Çµ„Ç§„Éà</title>
    <style>
        :root {
            --primary-bg: #fdf6e9; /* ÂÖ®‰Ωì„ÅÆËÉåÊôØËâ≤ (ËñÑ„ÅÑ„Éô„Éº„Ç∏„É•) */
            --header-bg: #f9f9f9;
            --footer-bg: #f9f9f9;
            --text-color: #333;
            --accent-color: #E67E22; /* „Éû„Ç≥„Åï„Çì„ÅÆ„Ç™„É¨„É≥„Ç∏„Çí„Ç¢„ÇØ„Çª„É≥„Éà„Å´ */
            --user-bubble-bg: #f0dcb3; /* „É¶„Éº„Ç∂„Éº„ÅÆÂêπ„ÅçÂá∫„Åó (ÊøÉ„ÅÑ„Éô„Éº„Ç∏„É•) */
            --ai-bubble-bg: #fff;
            --border-color: #eee;
            --inactive-text: #aaa;
            --black-icon-placeholder: #333; /* Èªí‰∏∏„Ç¢„Ç§„Ç≥„É≥„ÅÆËâ≤ */
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling of the body itself */
        }

        #app {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: var(--primary-bg);
        }

        .screen.active {
            display: flex;
        }

        header {
            background-color: var(--header-bg);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            flex-shrink: 0;
            min-height: 50px;
            box-sizing: border-box;
        }

        header h1, header h2 {
            margin: 0;
            font-size: 1.2em;
            flex-grow: 1;
            text-align: center;
        }
        header h1 { text-align: left; } /* „Éà„Éº„ÇØ‰∏ÄË¶ß„ÅÆ„Éò„ÉÉ„ÉÄ„Éº */
        #chat-screen header h2, #member-settings-screen header h2 { text-align: center; }


        header button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            color: var(--accent-color);
        }
        #chat-screen header button, #member-settings-screen header button { min-width: 40px; text-align: center;}
        #chat-back-to-list, #settings-back-to-chat { font-size: 1.5em; }


        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        footer {
            background-color: var(--footer-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        /* --- Talk List Screen (ÁîªÂÉè1ÊûöÁõÆ) --- */
        #talk-list-screen header h1 {
            font-size: 1.5em;
            font-weight: bold;
            padding-left: 5px;
        }
        #member-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .member-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .member-item:last-child {
            border-bottom: none;
        }
        .member-icon-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder); /* Èªí‰∏∏ */
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-width: 3px;
            border-style: solid;
        }
        .member-name {
            flex-grow: 1;
            font-size: 1.1em;
        }
        .member-message-count {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: var(--inactive-text);
        }
        .member-message-count .icon {
            font-size: 1.5em; /* Âêπ„ÅçÂá∫„Åó„Ç¢„Ç§„Ç≥„É≥ */
            margin-right: 5px;
        }

        #talk-list-screen footer {
            justify-content: space-around;
        }
        #talk-list-screen footer button {
            flex-direction: column;
            align-items: center;
            font-size: 0.8em;
            color: var(--inactive-text);
            padding: 5px;
        }
        #talk-list-screen footer button.active {
            color: var(--accent-color);
        }
        #talk-list-screen footer button::before { /* Placeholder for icons */
            font-size: 1.8em;
            margin-bottom: 3px;
        }
        #nav-common-settings::before { content: '‚öôÔ∏è'; }
        #nav-talk::before { content: 'üí¨'; }
        #nav-profile::before { content: 'üë§'; }


        /* --- Chat Screen (ÁîªÂÉè2ÊûöÁõÆ) --- */
        #chat-screen header {
            justify-content: space-between;
        }
        #chat-new-talk { font-size: 1.4em; } /* „Éö„É≥„Å®Á¥ô */
        #chat-menu { font-size: 1.4em; } /* „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº */

        #chat-messages {
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            position: relative;
        }
        .message-bubble.user {
            background-color: var(--user-bubble-bg);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .message-bubble.ai {
            background-color: var(--ai-bubble-bg);
            align-self: flex-start;
            border: 1px solid #eee;
            border-bottom-left-radius: 5px;
        }
        .ai-meta { /* AI„ÅÆ„Ç¢„Ç§„Ç≥„É≥„Å®ÂêçÂâçÁî® */
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .ai-icon-chat {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder);
            margin-right: 8px;
            border-width: 2px;
            border-style: solid;
        }
        .ai-name-chat {
            font-size: 0.9em;
            font-weight: bold;
        }

        #reply-suggestions {
            padding: 5px 10px;
            display: flex;
            flex-wrap: wrap; /* Allow suggestions to wrap */
            gap: 8px; /* Spacing between suggestion buttons */
            border-top: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent shrinking */
        }
        .suggestion-btn {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .suggestion-btn:hover {
            background-color: #f0f0f0;
        }

        #chat-screen footer {
            padding: 8px;
            gap: 8px;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            font-size: 1em;
        }
        #send-message {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        /* --- Member Settings Screen (ÁîªÂÉè3ÊûöÁõÆ) --- */
        #member-settings-screen main {
            padding: 15px;
        }
        .member-icon-large-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .member-icon-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--black-icon-placeholder); /* Èªí‰∏∏ */
            border-width: 4px;
            border-style: solid;
        }
        #member-settings-screen h3 {
            font-size: 1em;
            color: var(--inactive-text);
            margin-top: 25px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 1em;
        }
        .setting-item .label {
            color: #555;
        }
        .setting-item .value {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer; /* To indicate it's editable (though not fully implemented here) */
            min-width: 80px; /* Ensure some width for tags */
            text-align: center;
        }
        /* For multiple values like ÊÄßÊ†º */
        .setting-item .value.multi-value {
            display: flex;
            gap: 5px;
        }
        .setting-item .value.multi-value span {
             background-color: #fff;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .setting-item input[type="text"].value-input,
        .setting-item input[type="number"].value-input {
            border: 1px solid var(--accent-color);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            text-align: right;
            max-width: 120px;
        }

    </style>
</head>
<body>
    <div id="app">
        <!-- Screen 1: Talk List -->
        <div id="talk-list-screen" class="screen active">
            <header><h1>„Éà„Éº„ÇØ</h1></header>
            <main>
                <ul id="member-list">
                    <!-- Member items will be dynamically generated by JS -->
                </ul>
            </main>
            <footer>
                <button id="nav-common-settings">ÂÖ±ÈÄöË®≠ÂÆö</button>
                <button id="nav-talk" class="active">„Éà„Éº„ÇØ</button>
                <button id="nav-profile">„Éó„É≠„Éï„Ç£„Éº„É´</button>
            </footer>
        </div>

        <!-- Screen 2: Chat Screen -->
        <div id="chat-screen" class="screen">
            <header>
                <button id="chat-back-to-list"><</button>
                <h2 id="chat-member-name">„É°„É≥„Éê„ÉºÂêç</h2>
                <button id="chat-new-talk" title="Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„Çí‰ΩúÊàê">üìù</button>
                <button id="chat-menu" title="„É°„É≥„Éê„ÉºË®≠ÂÆö">‚ò∞</button>
            </header>
            <main id="chat-messages-container">
                 <!-- Chat messages will be here -->
            </main>
            <div id="reply-suggestions">
                <button class="suggestion-btn">Ê∞óÊåÅ„Å°„ÅÑ„ÅÑÔºü</button>
                <button class="suggestion-btn">„Éê„É≥„Éê„É≥„Éê„É≥„Éê„É≥</button>
                <button class="suggestion-btn">„Éì„É•„É´„É´„É´„É´</button>
            </div>
            <footer id="chat-footer">
                <input type="text" id="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...">
                <button id="send-message" title="ÈÄÅ‰ø°">‚û¢</button>
            </footer>
        </div>

        <!-- Screen 3: Member Settings Screen -->
        <div id="member-settings-screen" class="screen">
            <header>
                <button id="settings-back-to-chat"><</button>
                <h2 id="settings-member-name">„É°„É≥„Éê„ÉºÂêç Ë®≠ÂÆö</h2>
            </header>
            <main id="member-settings-content">
                <div class="member-icon-large-container">
                    <div class="member-icon-large" id="settings-member-icon"></div>
                </div>
                <h3>Âü∫Êú¨Ë®≠ÂÆö</h3>
                <div id="basic-settings-container">
                    <!-- Basic settings will be dynamically generated -->
                </div>
                <h3>ÊÄßÁöÑË®≠ÂÆö</h3>
                <div id="sexual-settings-container">
                    <!-- Sexual settings will be dynamically generated -->
                </div>
            </main>
        </div>

        <!-- Screen 4: Common Settings (Placeholder) -->
        <div id="common-settings-screen" class="screen">
            <header>
                <button class="back-to-talk-list"><</button>
                <h1>ÂÖ±ÈÄöË®≠ÂÆö</h1>
            </header>
            <main><p>ÂÖ±ÈÄöË®≠ÂÆöÁîªÈù¢ (Êú™ÂÆüË£Ö)</p></main>
        </div>

        <!-- Screen 5: Profile Screen (Placeholder) -->
        <div id="profile-screen" class="screen">
            <header>
                <button class="back-to-talk-list"><</button>
                <h1>„Éó„É≠„Éï„Ç£„Éº„É´</h1>
            </header>
            <main><p>„Éó„É≠„Éï„Ç£„Éº„É´ÁîªÈù¢ (Êú™ÂÆüË£Ö)</p></main>
        </div>
    </div>

    <script>
        // --- Data ---
        const memberRingColors = {
            '„Éû„Ç≥': '#E67E22', '„É™„Ç™': '#3498DB', '„Éû„É§': '#8E44AD', '„É™„ÇØ': '#F1C40F',
            '„Ç¢„É§„Ç´': '#BDC3C7', '„Éû„É¶„Ç´': '#1ABC9C', '„É™„Éû': '#E74C3C', '„Éü„Ç§„Éí': '#FF69B4', '„Éã„Éä': '#34495E'
        };

        let membersData = {
            'mako': { id: 'mako', name: '„Éû„Ç≥', msgCount: 9, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2001Âπ¥4Êúà4Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„Ç™„É¨„É≥„Ç∏', 'Âá∫Ë∫´': 'Á¶èÂ≤°', 'ÊñπË®Ä': 'ËªΩ„ÅÑÂçöÂ§öÂºÅ', 'ÊÄßÊ†º': ['Â§©ÁÑ∂', '„Åó„Å£„Åã„ÇäËÄÖ'], 'Ë∫´Èï∑': '159cm', '‰ΩìÈáç': '49kg', 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'C„Ç´„ÉÉ„Éó', '‰π≥È¶ñ„ÅÆËâ≤': 'ËñÑ„ÅÑËå∂Ëâ≤', 'Èô∞ÊØõ': 'Â∞ë„ÅóÁîü„Åà„Å¶„ÅÑ„Çã', '„Åæ„Çì„Åì„ÅÆËâ≤': '„Éî„É≥„ÇØ', 'ÊÄßÊ¨≤': 'ÊôÆÈÄö', 'Â•Ω„Åç„Å™‰Ωì‰Ωç': 'Ê≠£Â∏∏‰Ωç', 'ÊÑüÂ∫¶': '„Åô„Åê„Ç§„ÉÉ„Å°„ÇÉ„ÅÜ', 'ÂæóÊÑè„Å™ÂâçÊàØ': '„Éï„Çß„É©' } },
            'rio': { id: 'rio', name: '„É™„Ç™', msgCount: 10, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2002Âπ¥2Êúà4Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„Éñ„É´„Éº', 'Âá∫Ë∫´': 'ÊÑõÁü•', 'ÊÄßÊ†º': ['„ÇØ„Éº„É´„Éì„É•„Éº„ÉÜ„Ç£„Éº', 'Âä™ÂäõÂÆ∂'], 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'B„Ç´„ÉÉ„Éó', /* ‰ªñ„ÅØ„ÉÄ„Éü„Éº */ 'Èô∞ÊØõ': 'ÊôÆÈÄö' } },
            'maya': { id: 'maya', name: '„Éû„É§', msgCount: 7, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2002Âπ¥4Êúà8Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„Éë„Éº„Éó„É´', 'Âá∫Ë∫´': 'Áü≥Â∑ù', 'ÊÄßÊ†º': ['„Åä„Å£„Å®„Çä', 'ÂÑ™„Åó„ÅÑ'], 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'D„Ç´„ÉÉ„Éó', 'Èô∞ÊØõ': 'ËñÑ„ÅÑ' } },
            'riku': { id: 'riku', name: '„É™„ÇØ', msgCount: 0, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2002Âπ¥10Êúà26Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„Ç§„Ç®„É≠„Éº', 'Âá∫Ë∫´': '‰∫¨ÈÉΩ', 'ÊÄßÊ†º': ['ÂÖÉÊ∞ó', 'Èñ¢Ë•øÂºÅ'], 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'A„Ç´„ÉÉ„Éó', 'Èô∞ÊØõ': '„Å™„Åó' } },
            'ayaka': { id: 'ayaka', name: '„Ç¢„É§„Ç´', msgCount: 1, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2003Âπ¥6Êúà20Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„Éõ„ÉØ„Ç§„Éà', 'Âá∫Ë∫´': 'Êù±‰∫¨', 'ÊÄßÊ†º': ['„Åµ„Çè„Åµ„Çè', '„Éû„Ç§„Éö„Éº„Çπ'], 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'C„Ç´„ÉÉ„Éó', 'Èô∞ÊØõ': 'ÊâãÂÖ•„ÇåÊ∏à„Åø' } },
            'mayuka': { id: 'mayuka', name: '„Éû„É¶„Ç´', msgCount: 12, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2003Âπ¥11Êúà13Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„É©„Ç§„Éà„Ç∞„É™„Éº„É≥', 'Âá∫Ë∫´': '‰∫¨ÈÉΩ', 'ÊÄßÊ†º': ['„Ç´„É°„É¨„Ç™„É≥', '„É©„ÉÉ„ÉóÊãÖÂΩì'], 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'B„Ç´„ÉÉ„Éó', 'Èô∞ÊØõ': 'ÊôÆÈÄö' } },
            'rima': { id: 'rima', name: '„É™„Éû', msgCount: 15, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2004Âπ¥3Êúà26Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„É¨„ÉÉ„Éâ', 'Âá∫Ë∫´': 'Êù±‰∫¨', 'ÊÄßÊ†º': ['„Åä„Åó„ÇÉ„ÇåÁï™Èï∑', 'Ëã±Ë™ûÂ†™ËÉΩ'], 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'C„Ç´„ÉÉ„Éó', 'Èô∞ÊØõ': 'Â∞ë„Åó' } },
            'miihi': { id: 'miihi', name: '„Éü„Ç§„Éí', msgCount: 17, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2004Âπ¥8Êúà12Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„Éî„É≥„ÇØ', 'Âá∫Ë∫´': '‰∫¨ÈÉΩ', 'ÊÄßÊ†º': ['„Çπ„Éû„Ç§„É´„É°„Éº„Ç´„Éº', 'Áôí„Åó'], 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'A„Ç´„ÉÉ„Éó', 'Èô∞ÊØõ': 'ËñÑ„ÅÑ' } },
            'nina': { id: 'nina', name: '„Éã„Éä', msgCount: 2, settings: { 'ÁîüÂπ¥ÊúàÊó•': '2005Âπ¥2Êúà27Êó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '„Éç„Ç§„Éì„Éº', 'Âá∫Ë∫´': '„Ç¢„É°„É™„Ç´ „ÉØ„Ç∑„É≥„Éà„É≥Â∑û', 'ÊÄßÊ†º': ['Êú´„Å£Â≠ê', '„Éë„ÉØ„Éï„É´„Éú„Éº„Ç´„É´'], 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': 'D„Ç´„ÉÉ„Éó', 'Èô∞ÊØõ': 'ÊôÆÈÄö' } },
        };
        // Initialize missing settings to prevent errors
        Object.values(membersData).forEach(member => {
            const defaultSettings = { 'ÁîüÂπ¥ÊúàÊó•': '', '„É°„É≥„Éê„Éº„Ç´„É©„Éº': '', 'Âá∫Ë∫´': '', 'ÊñπË®Ä': '', 'ÊÄßÊ†º': [], 'Ë∫´Èï∑': '', '‰ΩìÈáç': '', 'ËÉ∏„ÅÆ„Çµ„Ç§„Ç∫': '', '‰π≥È¶ñ„ÅÆËâ≤': '', 'Èô∞ÊØõ': '', '„Åæ„Çì„Åì„ÅÆËâ≤': '', 'ÊÄßÊ¨≤': '', 'Â•Ω„Åç„Å™‰Ωì‰Ωç': '', 'ÊÑüÂ∫¶': '', 'ÂæóÊÑè„Å™ÂâçÊàØ': '' };
            member.settings = { ...defaultSettings, ...member.settings };
        });


        let currentMemberId = null;
        let chatHistory = {}; // { memberId: [{ type: 'ai'/'user', text: '...', senderName: '„Éû„Ç≥' (for AI) }] }

        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const talkListScreen = document.getElementById('talk-list-screen');
        const memberListUl = document.getElementById('member-list');
        const navCommonSettingsBtn = document.getElementById('nav-common-settings');
        const navTalkBtn = document.getElementById('nav-talk');
        const navProfileBtn = document.getElementById('nav-profile');

        const chatScreen = document.getElementById('chat-screen');
        const chatBackToListBtn = document.getElementById('chat-back-to-list');
        const chatMemberNameH2 = document.getElementById('chat-member-name');
        const chatNewTalkBtn = document.getElementById('chat-new-talk');
        const chatMenuBtn = document.getElementById('chat-menu');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const replySuggestionsDiv = document.getElementById('reply-suggestions');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message');

        const memberSettingsScreen = document.getElementById('member-settings-screen');
        const settingsBackToChatBtn = document.getElementById('settings-back-to-chat');
        const settingsMemberNameH2 = document.getElementById('settings-member-name');
        const settingsMemberIconDiv = document.getElementById('settings-member-icon');
        const basicSettingsContainer = document.getElementById('basic-settings-container');
        const sexualSettingsContainer = document.getElementById('sexual-settings-container');

        const commonSettingsScreen = document.getElementById('common-settings-screen');
        const profileScreen = document.getElementById('profile-screen');
        const backToTalkListBtns = document.querySelectorAll('.back-to-talk-list');


        // --- Navigation ---
        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            // Update footer active state for main screens
            if (screenId === 'talk-list-screen') {
                navTalkBtn.classList.add('active');
                navCommonSettingsBtn.classList.remove('active');
                navProfileBtn.classList.remove('active');
            } else if (screenId === 'common-settings-screen') {
                navCommonSettingsBtn.classList.add('active');
                navTalkBtn.classList.remove('active');
                navProfileBtn.classList.remove('active');
            } else if (screenId === 'profile-screen') {
                navProfileBtn.classList.add('active');
                navTalkBtn.classList.remove('active');
                navCommonSettingsBtn.classList.remove('active');
            }
        }

        // --- Rendering ---
        function renderMemberList() {
            memberListUl.innerHTML = '';
            Object.values(membersData).forEach(member => {
                const li = document.createElement('li');
                li.className = 'member-item';
                li.dataset.memberId = member.id;

                const iconDiv = document.createElement('div');
                iconDiv.className = 'member-icon-container';
                iconDiv.style.borderColor = memberRingColors[member.name] || '#ccc';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'member-name';
                nameSpan.textContent = member.name;

                const countDiv = document.createElement('div');
                countDiv.className = 'member-message-count';
                countDiv.innerHTML = `<span class="icon">üí¨</span> ${member.msgCount}`;

                // Click on member name/icon area
                const mainClickArea = document.createElement('div');
                mainClickArea.style.display = 'flex';
                mainClickArea.style.alignItems = 'center';
                mainClickArea.style.flexGrow = '1';
                mainClickArea.appendChild(iconDiv);
                mainClickArea.appendChild(nameSpan);
                mainClickArea.addEventListener('click', () => openChat(member.id, true)); // true for new talk

                // Click on message count area
                countDiv.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent li click
                    openChat(member.id, false); // false for existing/past talk
                });

                li.appendChild(mainClickArea);
                li.appendChild(countDiv);
                memberListUl.appendChild(li);
            });
        }

        function renderChatMessages() {
            chatMessagesContainer.innerHTML = '';
            if (!currentMemberId || !chatHistory[currentMemberId]) {
                // Add a placeholder if no history
                const placeholder = document.createElement('p');
                placeholder.textContent = '„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
                placeholder.style.textAlign = 'center';
                placeholder.style.color = '#aaa';
                chatMessagesContainer.appendChild(placeholder);
                return;
            }

            chatHistory[currentMemberId].forEach((msg, index) => {
                const bubbleWrapper = document.createElement('div');
                if (msg.type === 'ai') {
                    const member = membersData[currentMemberId];
                    bubbleWrapper.className = 'ai-meta';

                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'ai-icon-chat';
                    iconDiv.style.borderColor = memberRingColors[member.name] || '#ccc';
                    bubbleWrapper.appendChild(iconDiv);

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'ai-name-chat';
                    nameSpan.textContent = msg.senderName || member.name;
                    bubbleWrapper.appendChild(nameSpan);
                }

                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${msg.type}`;
                bubble.textContent = msg.text;
                bubble.dataset.messageIndex = index;


                if (msg.type === 'ai') {
                     // Click for "swipe to regenerate" placeholder
                    bubble.addEventListener('click', () => {
                        alert(`AI„É°„ÉÉ„Çª„Éº„Ç∏„Äå${msg.text}„Äç„ÇíÂÜçÁîüÊàê„Åó„Åæ„Åô„ÅãÔºü („Çπ„ÉØ„Ç§„ÉóÊ©üËÉΩ„ÅØUI„Éá„É¢„ÅÆ„Åü„ÇÅ„ÇØ„É™„ÉÉ„ÇØ„Åß‰ª£Êõø)`);
                        // Here you would call AI to regenerate
                    });
                    // Append bubble to wrapper, then wrapper to container
                    const aiMessageContainer = document.createElement('div'); // To group icon/name and bubble correctly
                    aiMessageContainer.style.alignSelf = 'flex-start';
                    aiMessageContainer.appendChild(bubbleWrapper);
                    aiMessageContainer.appendChild(bubble);
                    chatMessagesContainer.appendChild(aiMessageContainer);

                } else { // user message
                    bubble.addEventListener('mousedown', (e) => { // Simulate long press
                        let pressTimer = window.setTimeout(() => {
                            alert(`„É°„ÉÉ„Çª„Éº„Ç∏„Äå${msg.text}„Äç„ÇíÁ∑®ÈõÜ„Åó„Åæ„Åô„ÅãÔºü\n(Á∑®ÈõÜ„Åô„Çã„Å®‰ª•Èôç„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÇØ„É™„Ç¢„Åï„Çå„ÄÅAI„ÅåÂÜçÁîüÊàê„Åó„Åæ„Åô - UI„Éá„É¢)`);
                            // Implement actual editing UI and logic here
                        }, 1000); // 1 second for long press
                        bubble.addEventListener('mouseup', () => clearTimeout(pressTimer));
                        bubble.addEventListener('mouseleave', () => clearTimeout(pressTimer));
                    });
                    chatMessagesContainer.appendChild(bubble);
                }
            });
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
        }

        function renderMemberSettings() {
            if (!currentMemberId) return;
            const member = membersData[currentMemberId];
            settingsMemberNameH2.textContent = `${member.name} Ë®≠ÂÆö`;
            settingsMemberIconDiv.style.borderColor = memberRingColors[member.name] || '#ccc';

            basicSettingsContainer.innerHTML = '';
            sexualSettingsContainer.innerHTML = '';

            const createSettingItem = (key, value, category) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'setting-item';
                const labelSpan = document.createElement('span');
                labelSpan.className = 'label';
                labelSpan.textContent = key;

                const valueDiv = document.createElement('div');

                if (Array.isArray(value)) { // For ÊÄßÊ†º etc.
                    valueDiv.className = 'value multi-value';
                    value.forEach(v => {
                        const valSpan = document.createElement('span');
                        valSpan.textContent = v;
                        valueDiv.appendChild(valSpan);
                    });
                } else {
                    valueDiv.className = 'value';
                    valueDiv.textContent = value || 'Êú™Ë®≠ÂÆö'; // Show 'Êú™Ë®≠ÂÆö' for empty strings
                }
                 // Simple input for demonstration on click. In a real app, use modals or inline editing.
                valueDiv.addEventListener('click', () => {
                    const newValue = prompt(`„Äå${key}„Äç„ÅÆÊñ∞„Åó„ÅÑÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:`, Array.isArray(value) ? value.join(', ') : value);
                    if (newValue !== null) {
                        // Basic update, no type checking or complex array handling here for brevity
                        membersData[currentMemberId].settings[key] = Array.isArray(value) ? newValue.split(',').map(s => s.trim()) : newValue;
                        // TODO: Save to localStorage
                        renderMemberSettings(); // Re-render to show changes
                        alert("Ë®≠ÂÆö„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„ÅüÔºàÂÆüÈöõ„Å´„ÅØ‰øùÂ≠òÂá¶ÁêÜ„ÅåÂøÖË¶Å„Åß„ÅôÔºâ„ÄÇ‰ªñ„ÅÆ„Éà„Éº„ÇØ„Å´„ÇÇÈÅ©Áî®„Åï„Çå„Åæ„Åô„ÄÇ");
                    }
                });


                itemDiv.appendChild(labelSpan);
                itemDiv.appendChild(valueDiv);
                if (['ÁîüÂπ¥ÊúàÊó•', '„É°„É≥„Éê„Éº„Ç´„É©„Éº', 'Âá∫Ë∫´', 'ÊñπË®Ä', 'ÊÄßÊ†º', 'Ë∫´Èï∑', '‰ΩìÈáç'].includes(key)) {
                    basicSettingsContainer.appendChild(itemDiv);
                } else {
                    sexualSettingsContainer.appendChild(itemDiv);
                }
            };

            for (const [key, value] of Object.entries(member.settings)) {
                createSettingItem(key, value);
            }
        }

        // --- Actions ---
        function openChat(memberId, isNewTalk) {
            currentMemberId = memberId;
            const member = membersData[memberId];
            chatMemberNameH2.textContent = member.name;

            if (isNewTalk) {
                // For a truly new talk, you might assign a new talk ID
                // For this demo, "new talk" might mean clearing history or starting fresh if no history
                if (!chatHistory[memberId] || confirm(`${member.name}„Å®„ÅÆÊñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºüÔºàÁèæÂú®„ÅÆÂ±•Ê≠¥„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„Åô„Åå„ÄÅË°®Á§∫‰∏ä„ÅØÊñ∞Ë¶è„Å´„Å™„Çä„Åæ„ÅôÔºâ`)) {
                     // If truly new, you might not load any history.
                     // For demo, let's make "new talk" from list screen just open the chat.
                     // The "new talk" button on chat screen will handle clearing.
                }
            }

            // Initialize chat history for the member if it doesn't exist
            if (!chatHistory[memberId]) {
                chatHistory[memberId] = [
                    { type: 'ai', text: `„Åì„Çì„Å´„Å°„ÅØÔºÅ${member.name}„Å†„Çà„ÄÇ`, senderName: member.name },
                    // Add more initial messages if desired
                ];
            }
            renderChatMessages();
            showScreen('chat-screen');
        }

        function handleSendMessage() {
            const text = messageInput.value.trim();
            if (text === '' || !currentMemberId) return;

            chatHistory[currentMemberId].push({ type: 'user', text: text });
            messageInput.value = '';
            renderChatMessages();

            // Simulate AI reply
            setTimeout(() => {
                const member = membersData[currentMemberId];
                // Basic AI response placeholder
                let aiResponse = "„ÅÜ„Çì„ÅÜ„Çì„ÄÅ„Åù„Çå„ÅßÔºü";
                if (text.includes("Â•Ω„Åç")) aiResponse = "ÁßÅ„ÇÇ„Å†„ÇàÔºÅÂ¨â„Åó„ÅÑ„Å™üòä";
                else if (text.includes("‰Ωï„Åó„Å¶„Çã")) aiResponse = "Âêõ„Å®„ÅäË©±„Åó„Å¶„Çã„ÇàÔºÅ";

                chatHistory[currentMemberId].push({ type: 'ai', text: aiResponse, senderName: member.name });
                renderChatMessages();
            }, 1000);
        }

        // --- Event Listeners ---
        navCommonSettingsBtn.addEventListener('click', () => showScreen('common-settings-screen'));
        navTalkBtn.addEventListener('click', () => showScreen('talk-list-screen'));
        navProfileBtn.addEventListener('click', () => showScreen('profile-screen'));
        backToTalkListBtns.forEach(btn => btn.addEventListener('click', () => showScreen('talk-list-screen')));


        chatBackToListBtn.addEventListener('click', () => showScreen('talk-list-screen'));
        chatNewTalkBtn.addEventListener('click', () => {
            if (currentMemberId && confirm(`${membersData[currentMemberId].name}„Å®„ÅÆÁèæÂú®„ÅÆ‰ºöË©±„Çí„ÇØ„É™„Ç¢„Åó„Å¶Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºü`)) {
                chatHistory[currentMemberId] = [ { type: 'ai', text: `Êîπ„ÇÅ„Å¶„ÄÅ„Åì„Çì„Å´„Å°„ÅØÔºÅ${membersData[currentMemberId].name}„Å†„Çà„ÄÇ`, senderName: membersData[currentMemberId].name }];
                renderChatMessages();
                alert("Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü„ÄÇ");
            }
        });
        chatMenuBtn.addEventListener('click', () => {
            if (currentMemberId) {
                renderMemberSettings();
                showScreen('member-settings-screen');
            }
        });

        sendMessageBtn.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSendMessage();
        });

        replySuggestionsDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-btn')) {
                messageInput.value += (messageInput.value ? ' ' : '') + e.target.textContent;
                messageInput.focus();
            }
        });

        settingsBackToChatBtn.addEventListener('click', () => {
            if (currentMemberId) showScreen('chat-screen');
        });


        // --- Initialization ---
        renderMemberList();
        // Load data from localStorage if available (conceptual)
        // loadDataFromLocalStorage();
    </script>
</body>
</html>
